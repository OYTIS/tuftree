## A docker-compose backend for testing

This directory provides a docker-compose configuration sufficient for doing
development and local testing with. It can also help show what things are
needed in a production deployment.

You can get started by running:
~~~
$ docker-compose up
~~~

You'll then need to add an entry to /etc/hosts like:
~~~
<IP of System>	tuftree-notary
~~~

## Create Some Base OSTREE Updates
One time initalization:
~~~
$ notary -d /tmp/notary-trust --tlscacert ./fixtures/root-ca.crt -s https://tuftree-notary:4443 init hub.foundries.io/lmp
$ notary -d /tmp/notary-trust --tlscacert ./fixtures/root-ca.crt -s https://tuftree-notary:4443 init hub.foundries.io/gateway-lwm2m
~~~

## Add an "update"
~~~
# NOTE: This must be *canonical json* (ie keys must be in alphabetical order)
cat >/tmp/custom.json <<EOF
{
  "ostree": "https://api.foundries.io/lmp/treehub/release/api/v2/",
  "targetFormat": "OSTREE",
  "uri": "https://github.com/foundriesio/lmp-manifest/releases/tag/37"
}
EOF
$ notary -d /tmp/notary-trust --tlscacert ./fixtures/root-ca.crt -s https://tuftree-notary:4443 \
    addhash hub.foundries.io/lmp v37-raspberrypi3-64 0 --sha256 435b6162c6240ac995421d0417ebfa79cf0f6081d34f9d995a2431a695ded52b \
    --custom /tmp/custom.json -p

cat >/tmp/custom.json <<EOF
{
  "compose-env": {
    "TAG": "37"
  },
  "compose-files": ["docker-compose.lwm2m.yml"],
  "targetFormat": "DOCKER_COMPOSE",
  "tgz": "https://github.com/foundriesio/gateway-containers/archive/mp-37.tar.gz",
  "tgzLeadingDir": true,
  "uri": "https://github.com/foundriesio/gateway-containers/releases/tag/mp-37"
}
EOF
$ notary -d /tmp/notary-trust --tlscacert ./fixtures/root-ca.crt -s https://tuftree-notary:4443 \
    addhash hub.foundries.io/gateway-lwm2m v37 0 --sha256 ba3bb99b7432d9f5ec0e744b8e7e366afb371cf138785469918a54a6f8679a70 \
    --custom /tmp/custom.json -p
~~~

## Why not the docker-compose that comes with the Notary project?
The Notary server's key is only good for a host named "notary-server"
that's binding to 127.0.0.1. This makes it hard to run inside
docker-compose and have the service accessible to test devices on
your network.

The keys included were generated by running `./generate-keys.sh`. These
are **less** secure in a way, but are really the only way to test on a
home network without doing SSL port forwarding.

## Moving to Production
TODO - how to get SSL keys done right
TODO - notary token auth setup, should we include faux-auth2 with this?
